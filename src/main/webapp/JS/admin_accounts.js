document.addEventListener('DOMContentLoaded', () => {
    // --- Modal t·∫°o t√†i kho·∫£n m·ªõi ---
    const createForm = document.getElementById("createAccountForm");

    if (createForm) {
        // M·ªü modal t·∫°o t√†i kho·∫£n
        const openBtn = document.querySelector(".add-customer-btn");
        if (openBtn) {
            openBtn.addEventListener("click", () => {
                const modal = document.getElementById("createAccountModal");
                if (modal) modal.style.display = "block";
            });
        }

        // ƒê√≥ng modal khi b·∫•m n√∫t ƒë√≥ng
        const closeBtn = document.getElementById("createAccountModal")?.querySelector(".close-modal");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => {
                const modal = document.getElementById("createAccountModal");
                if (modal) modal.style.display = "none";
            });
        }

        // ƒê√≥ng modal khi click ra ngo√†i
        window.addEventListener("click", (event) => {
            const modal = document.getElementById("createAccountModal");
            if (event.target === modal) modal.style.display = "none";
        });

        // G·ª≠i d·ªØ li·ªáu t·∫°o t√†i kho·∫£n
        createForm.addEventListener("submit", async (event) => {
            event.preventDefault();

            const formData = new FormData(createForm);
            const params = new URLSearchParams();
            for (let [k, v] of formData) params.append(k, v);

            try {
                const response = await fetch("/SeafoodShop_war_exploded/CreateNewAccount", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: params.toString()
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const text = await response.text();
                console.log("Raw response text:", text);

                let result;
                try {
                    result = JSON.parse(text);
                } catch (e) {
                    throw new Error("Ph·∫£n h·ªìi kh√¥ng ph·∫£i JSON h·ª£p l·ªá");
                }

                if (result.success) {
                    showToast("T·∫°o t√†i kho·∫£n th√†nh c√¥ng!", "success");
                    document.getElementById("createAccountModal").style.display = "none";
                    createForm.reset();
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast("T·∫°o th·∫•t b·∫°i: " + (result.error || "Kh√¥ng r√µ l·ªói"), "error");
                }
            } catch (error) {
                console.error("Error:", error);
                showToast("L·ªói t·∫°o t√†i kho·∫£n: " + error.message, "error");
            }
        });
    }

    // H√†m hi·ªÉn th·ªã toast
    function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }, 100);
    }

    // X·ª≠ l√Ω ban/unban ng∆∞·ªùi d√πng
    document.querySelectorAll(".toggle-visibility").forEach(button => {
        button.addEventListener("click", async function () {
            const userId = this.dataset.userid;
            const currentBan = parseInt(this.dataset.currentban);
            const newBan = currentBan === 1 ? 0 : 1;
            const row = document.querySelector(`#user-row-${userId}`);
            const toggleBtn = this;

            try {
                const response = await fetch(
                    `/SeafoodShop_war_exploded/AdminAccount?userId=${userId}`, {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({banStatus: newBan})
                    });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();

                if (result.success) {
                    // 1) ·∫®n/hi·ªán row
                    row.classList.toggle("hidden-product", newBan === 1);

                    // 2) C·∫≠p nh·∫≠t tr·∫°ng th√°i t·∫°i n√∫t
                    toggleBtn.dataset.currentban = newBan;
                    toggleBtn.title = newBan === 1 ? "Unban" : "Ban";

                    // 3) Lu√¥n hi·ªÉn th·ªã icon üö´
                    toggleBtn.innerText = 'üö´';

                    showToast(
                        newBan === 1 ? "ƒê√£ ban ng∆∞·ªùi d√πng" : "ƒê√£ unban ng∆∞·ªùi d√πng",
                        "success"
                    );
                } else {
                    showToast("C·∫≠p nh·∫≠t tr·∫°ng th√°i th·∫•t b·∫°i", "error");
                }
            } catch (error) {
                console.error("Error:", error);
                showToast("ƒê√£ x·∫£y ra l·ªói: " + error.message, "error");
            }
        });
    });

    // Khai b√°o modals
    const modals = {
        edit: {
            element: document.getElementById("editUserPopup"),
        }
    };

// X·ª≠ l√Ω popup ch·ªânh s·ª≠a ng∆∞·ªùi d√πng
    const editForm = document.getElementById("editUserForm");

    if (editForm) {

        // ƒê√≥ng popup khi nh·∫•n n√∫t X
        const closeBtn = document.getElementById("closeEditPopup");
        if (closeBtn) {
            closeBtn.addEventListener("click", () => {
                modals.edit.element.style.display = "none";
            });
        }

        // ƒê√≥ng popup khi nh·∫•n ra ngo√†i modal-content
        window.addEventListener("click", function (event) {
            if (event.target === modals.edit.element) {
                modals.edit.element.style.display = "none";
            }
        });

        // M·ªü popup ch·ªânh s·ª≠a
        document.querySelectorAll(".edit").forEach(button => {
            button.addEventListener("click", async function () {
                const userID = this.getAttribute("data-userid");
                if (!userID) {
                    showToast("Kh√¥ng th·ªÉ ch·ªânh s·ª≠a: Thi·∫øu ID ng∆∞·ªùi d√πng", "error");
                    return;
                }
                try {
                    const response = await fetch(`/SeafoodShop_war_exploded/EditUserInformation?userID=${userID}`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const user = await response.json();
                    if (!user || user.error) throw new Error(user?.error || "Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng");
                    fillEditForm(user);

                    // Hi·ªÉn th·ªã modal
                    if (modals.edit.element) {
                        modals.edit.element.style.display = "block";
                    }
                } catch (error) {
                    console.error("Error:", error);
                    showToast("L·ªói khi t·∫£i th√¥ng tin: " + error.message, "error");
                }
            });
        });

        // Submit form ch·ªânh s·ª≠a (URL-encoded)
        editForm.addEventListener("submit", async function (event) {
            event.preventDefault();
            const userID = document.getElementById("UserID").value;
            const formData = new FormData(this);
            const params = new URLSearchParams();
            for (let [k, v] of formData) params.append(k, v);

            try {
                const response = await fetch(`/SeafoodShop_war_exploded/EditUserInformation?userID=${userID}`, {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: params.toString()
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                if (result.status === "success") {
                    showToast("C·∫≠p nh·∫≠t th√†nh c√¥ng!", "success");
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast("C·∫≠p nh·∫≠t th·∫•t b·∫°i: " + (result.message || ""), "error");
                }
            } catch (error) {
                console.error("Error:", error);
                showToast("L·ªói khi c·∫≠p nh·∫≠t: " + error.message, "error");
            }
        });
    }


    // H√†m ƒëi·ªÅn d·ªØ li·ªáu v√†o form ch·ªânh s·ª≠a
    function fillEditForm(user) {
        document.getElementById("UserID").value = user.userID;
        document.getElementById("editFullName").value = user.fullName || "";
        document.getElementById("editUsername").value = user.username || "";
        document.getElementById("editPassword").value = user.password || "";
        document.getElementById("editEmail").value = user.email || "";
        document.getElementById("editPhone").value = user.phone || "";
        document.getElementById("editBirthDate").value = user.birthday
            ? new Date(user.birthday).toISOString().split('T')[0]
            : "";
        document.getElementById("editAddress").value = user.address || "";
        document.getElementById("editRole").value = user.role || "0";
        document.getElementById("editBan").value = user.ban === 1 ? "1" : "0";
        if (document.getElementById("editCreatedAt")) {
            const d = new Date(user.editCreatedAt);
            document.getElementById("editCreatedAt").value =
                !isNaN(d.getTime())
                    ? d.toLocaleString()
                    : "";
        }

    }

    // H√†m hi·ªÉn th·ªã th√¥ng b√°o toast
    function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.add("show");
            setTimeout(() => {
                toast.classList.remove("show");
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }, 100);
    }
});
